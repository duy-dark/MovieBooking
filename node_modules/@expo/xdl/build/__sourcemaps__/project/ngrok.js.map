{"version":3,"sources":["project/ngrok.ts"],"names":["getNgrokConfigPath","path","join","UserSettings","dotExpoHomeDirectory","connectToNgrokAsync","projectRoot","ngrok","args","hostnameAsync","ngrokPid","attempts","ngrokConnectAsync","connect","ngrokKillAsync","kill","configPath","hostname","url","e","message","XDLError","toString","JSON","stringify","error_code","process","Logger","logDebug","Exp","resetProjectRandomnessAsync","TUNNEL_TIMEOUT","startTunnelsAsync","options","username","UserManager","getCurrentUsernameAsync","ANONYMOUS_USERNAME","packagerInfo","ProjectSettings","readPackagerInfoAsync","packagerPort","expoServerPort","stopTunnelsAsync","Android","startAdbReverseAsync","logInfo","packageShortName","parse","base","expRc","startedTunnelsSuccessfully","Promise","race","Error","expoServerNgrokUrl","authtoken","Config","authToken","port","proto","randomness","manifestTunnelRandomness","getProjectRandomnessAsync","UrlUtils","domainify","domain","packagerNgrokUrl","setPackagerInfoAsync","pid","logWithLevel","tag","_expoEventType","addListener","status","logError","shouldPrompt","catch","ngrokProcess","ngrokProcessPid","removeAllListeners","stopAdbReverseAsync"],"mappings":";;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAEA,SAASA,kBAAT,GAA8B;AAC5B,SAAOC,IAAI,GAACC,IAAL,CAAUC,wBAAaC,oBAAb,EAAV,EAA+C,WAA/C,CAAP;AACD;;AAED,eAAeC,mBAAf,CACEC,WADF,EAEEC,KAFF,EAGEC,IAHF,EAIEC,aAJF,EAKEC,QALF,EAMEC,QAAgB,GAAG,CANrB,EAOmB;AACjB,QAAMC,iBAAiB,GAAG,uBAAUL,KAAK,CAACM,OAAhB,CAA1B;AACA,QAAMC,cAAc,GAAG,uBAAUP,KAAK,CAACQ,IAAhB,CAAvB;;AAEA,MAAI;AACF,UAAMC,UAAU,GAAGhB,kBAAkB,EAArC;AACA,UAAMiB,QAAQ,GAAG,MAAMR,aAAa,EAApC;AACA,UAAMS,GAAG,GAAG,MAAMN,iBAAiB,CAAC;AAClCK,MAAAA,QADkC;AAElCD,MAAAA,UAFkC;AAGlC,SAAGR;AAH+B,KAAD,CAAnC;AAKA,WAAOU,GAAP;AACD,GATD,CASE,OAAOC,CAAP,EAAU;AACV;AACA,QAAIR,QAAQ,IAAI,CAAhB,EAAmB;AACjB,UAAIQ,CAAC,CAACC,OAAN,EAAe;AACb,cAAM,KAAIC,mBAAJ,EAAa,aAAb,EAA4BF,CAAC,CAACG,QAAF,EAA5B,CAAN;AACD,OAFD,MAEO;AACL,cAAM,KAAID,mBAAJ,EAAa,aAAb,EAA4BE,IAAI,CAACC,SAAL,CAAeL,CAAf,CAA5B,CAAN;AACD;AACF;;AACD,QAAI,CAACR,QAAL,EAAe;AACbA,MAAAA,QAAQ,GAAG,CAAX;AACD,KAXS,CAWR;;;AACF,QAAIQ,CAAC,CAACM,UAAF,IAAgBN,CAAC,CAACM,UAAF,KAAiB,GAArC,EAA0C;AACxC,UAAId,QAAQ,KAAK,CAAjB,EAAoB;AAClB;AACA,YAAID,QAAJ,EAAc;AACZ,cAAI;AACFgB,YAAAA,OAAO,CAACX,IAAR,CAAaL,QAAb,EAAuB,SAAvB;AACD,WAFD,CAEE,OAAOS,CAAP,EAAU;AACVQ,YAAAA,MAAM,GAACC,QAAP,CAAgBtB,WAAhB,EAA6B,MAA7B,EAAsC,gCAA+BI,QAAS,EAA9E;AACD;AACF,SAND,MAMO;AACL,gBAAMI,cAAc,EAApB;AACD;AACF,OAXD,MAWO;AACL;AACA,cAAMe,GAAG,GAACC,2BAAJ,CAAgCxB,WAAhC,CAAN;AACD;AACF,KA5BS,CA4BR;;;AACF,UAAM,2BAAW,GAAX,CAAN;AACA,WAAOD,mBAAmB,CAACC,WAAD,EAAcC,KAAd,EAAqBC,IAArB,EAA2BC,aAA3B,EAA0C,IAA1C,EAAgDE,QAAQ,GAAG,CAA3D,CAA1B;AACD;AACF;;AAED,MAAMoB,cAAc,GAAG,KAAK,IAA5B;;AAEO,eAAeC,iBAAf,CACL1B,WADK,EAEL2B,OAAkC,GAAG,EAFhC,EAGU;AACf,QAAM1B,KAAK,GAAG,MAAM,uCAAkBD,WAAlB,EAA+B2B,OAA/B,CAApB;;AAEA,QAAMC,QAAQ,GAAG,CAAC,MAAMC,gBAAYC,uBAAZ,EAAP,KAAiDC,0BAAlE;;AACA,wCAAuB/B,WAAvB;AACA,QAAMgC,YAAY,GAAG,MAAMC,eAAe,GAACC,qBAAhB,CAAsClC,WAAtC,CAA3B;;AACA,MAAI,CAACgC,YAAY,CAACG,YAAlB,EAAgC;AAC9B,UAAM,KAAIpB,mBAAJ,EAAa,kBAAb,EAAkC,oCAAmCf,WAAY,GAAjF,CAAN;AACD;;AACD,MAAI,CAACgC,YAAY,CAACI,cAAlB,EAAkC;AAChC,UAAM,KAAIrB,mBAAJ,EACJ,qBADI,EAEH,uCAAsCf,WAAY,GAF/C,CAAN;AAID;;AACD,QAAMoC,cAAc,GAAGJ,YAAY,CAACI,cAApC;AACA,QAAMC,gBAAgB,CAACrC,WAAD,CAAtB;;AACA,MAAI,MAAMsC,OAAO,GAACC,oBAAR,CAA6BvC,WAA7B,CAAV,EAAqD;AACnDqB,IAAAA,MAAM,GAACmB,OAAP,CACExC,WADF,EAEE,MAFF,EAGE,6FAHF;AAKD;;AACD,QAAMyC,gBAAgB,GAAG9C,IAAI,GAAC+C,KAAL,CAAW1C,WAAX,EAAwB2C,IAAjD;AACA,QAAMC,KAAK,GAAG,MAAM,8BAAe5C,WAAf,CAApB;AAEA,MAAI6C,0BAA0B,GAAG,KAAjC,CA3Be,CA6Bf;AACA;;AACA,QAAMC,OAAO,CAACC,IAAR,CAAa,CACjB,CAAC,YAAY;AACX,UAAM,2BAAWtB,cAAX,CAAN;;AACA,QAAI,CAACoB,0BAAL,EAAiC;AAC/B,YAAM,IAAIG,KAAJ,CAAU,4BAAV,CAAN;AACD;AACF,GALD,GADiB,EAOjB,CAAC,YAAY;AACX,UAAMC,kBAAkB,GAAG,MAAMlD,mBAAmB,CAClDC,WADkD,EAElDC,KAFkD,EAGlD;AACEiD,MAAAA,SAAS,EAAEC,kBAAOlD,KAAP,CAAamD,SAD1B;AAEEC,MAAAA,IAAI,EAAEjB,cAFR;AAGEkB,MAAAA,KAAK,EAAE;AAHT,KAHkD,EAQlD,YAAY;AACV,YAAMC,UAAU,GAAGX,KAAK,CAACY,wBAAN,GACfZ,KAAK,CAACY,wBADS,GAEf,MAAMjC,GAAG,GAACkC,yBAAJ,CAA8BzD,WAA9B,CAFV;AAGA,aAAO,CACLuD,UADK,EAELG,QAAQ,GAACC,SAAT,CAAmB/B,QAAnB,CAFK,EAGL8B,QAAQ,GAACC,SAAT,CAAmBlB,gBAAnB,CAHK,EAILU,kBAAOlD,KAAP,CAAa2D,MAJR,EAKLhE,IALK,CAKA,GALA,CAAP;AAMD,KAlBiD,EAmBlDoC,YAAY,CAAC5B,QAnBqC,CAApD;AAqBA,UAAMyD,gBAAgB,GAAG,MAAM9D,mBAAmB,CAChDC,WADgD,EAEhDC,KAFgD,EAGhD;AACEiD,MAAAA,SAAS,EAAEC,kBAAOlD,KAAP,CAAamD,SAD1B;AAEEC,MAAAA,IAAI,EAAErB,YAAY,CAACG,YAFrB;AAGEmB,MAAAA,KAAK,EAAE;AAHT,KAHgD,EAQhD,YAAY;AACV,YAAMC,UAAU,GAAGX,KAAK,CAACY,wBAAN,GACfZ,KAAK,CAACY,wBADS,GAEf,MAAMjC,GAAG,GAACkC,yBAAJ,CAA8BzD,WAA9B,CAFV;AAGA,aAAO,CACL,UADK,EAELuD,UAFK,EAGLG,QAAQ,GAACC,SAAT,CAAmB/B,QAAnB,CAHK,EAIL8B,QAAQ,GAACC,SAAT,CAAmBlB,gBAAnB,CAJK,EAKLU,kBAAOlD,KAAP,CAAa2D,MALR,EAMLhE,IANK,CAMA,GANA,CAAP;AAOD,KAnB+C,EAoBhDoC,YAAY,CAAC5B,QApBmC,CAAlD;AAsBA,UAAM6B,eAAe,GAAC6B,oBAAhB,CAAqC9D,WAArC,EAAkD;AACtDiD,MAAAA,kBADsD;AAEtDY,MAAAA,gBAFsD;AAGtDzD,MAAAA,QAAQ,EAAEH,KAAK,CAACmB,OAAN,GAAgB2C;AAH4B,KAAlD,CAAN;AAMAlB,IAAAA,0BAA0B,GAAG,IAA7B;AAEAxB,IAAAA,MAAM,GAAC2C,YAAP,CACEhE,WADF,EAEE,MAFF,EAGE;AACEiE,MAAAA,GAAG,EAAE,MADP;AAEEC,MAAAA,cAAc,EAAE;AAFlB,KAHF,EAOE,eAPF;AAUAjE,IAAAA,KAAK,CAACkE,WAAN,CAAkB,cAAlB,EAAmCC,MAAD,IAAoB;AACpD,UAAIA,MAAM,KAAK,cAAf,EAA+B;AAC7B/C,QAAAA,MAAM,GAACgD,QAAP,CACErE,WADF,EAEE,MAFF,EAGE,8CACE,qEADF,GAEE,0EAFF,GAGE,wBANJ;AAQD,OATD,MASO,IAAIoE,MAAM,KAAK,QAAf,EAAyB;AAC9B/C,QAAAA,MAAM,GAACmB,OAAP,CAAexC,WAAf,EAA4B,MAA5B,EAAoC,mBAApC;AACD;AACF,KAbD;AAcD,GA5ED,GAPiB,CAAb,CAAN;AAqFD;;AAEM,eAAeqC,gBAAf,CAAgCrC,WAAhC,EAAoE;AACzE,wCAAuBA,WAAvB;AACA,QAAMC,KAAK,GAAG,MAAM,uCAAkBD,WAAlB,EAA+B;AAAEsE,IAAAA,YAAY,EAAE;AAAhB,GAA/B,EAAwDC,KAAxD,CAA8D,MAAM,IAApE,CAApB;;AACA,MAAI,CAACtE,KAAL,EAAY;AACV;AACD;;AACD,QAAMO,cAAc,GAAG,uBAAUP,KAAK,CAACQ,IAAhB,CAAvB,CANyE,CAQzE;AACA;AACA;;AACA,QAAMuB,YAAY,GAAG,MAAMC,eAAe,GAACC,qBAAhB,CAAsClC,WAAtC,CAA3B;AACA,QAAMwE,YAAY,GAAGvE,KAAK,CAACmB,OAAN,EAArB;AACA,QAAMqD,eAAe,GAAGD,YAAY,GAAGA,YAAY,CAACT,GAAhB,GAAsB,IAA1D;AACA9D,EAAAA,KAAK,CAACyE,kBAAN,CAAyB,cAAzB;;AACA,MAAI1C,YAAY,CAAC5B,QAAb,IAAyB4B,YAAY,CAAC5B,QAAb,KAA0BqE,eAAvD,EAAwE;AACtE;AACA,QAAI;AACFrD,MAAAA,OAAO,CAACX,IAAR,CAAauB,YAAY,CAAC5B,QAA1B;AACD,KAFD,CAEE,OAAOS,CAAP,EAAU;AACVQ,MAAAA,MAAM,GAACC,QAAP,CAAgBtB,WAAhB,EAA6B,MAA7B,EAAsC,gCAA+BgC,YAAY,CAAC5B,QAAS,EAA3F;AACD;AACF,GAPD,MAOO;AACL;AACA,UAAMI,cAAc,EAApB;AACD;;AACD,QAAMyB,eAAe,GAAC6B,oBAAhB,CAAqC9D,WAArC,EAAkD;AACtDiD,IAAAA,kBAAkB,EAAE,IADkC;AAEtDY,IAAAA,gBAAgB,EAAE,IAFoC;AAGtDzD,IAAAA,QAAQ,EAAE;AAH4C,GAAlD,CAAN;AAKA,QAAMkC,OAAO,GAACqC,mBAAR,CAA4B3E,WAA5B,CAAN;AACD","sourcesContent":["import { readExpRcAsync } from '@expo/config';\nimport delayAsync from 'delay-async';\nimport * as path from 'path';\nimport { promisify } from 'util';\n\nimport * as Android from '../Android';\nimport Config from '../Config';\nimport * as Exp from '../Exp';\nimport * as ProjectSettings from '../ProjectSettings';\nimport * as UrlUtils from '../UrlUtils';\nimport UserManager, { ANONYMOUS_USERNAME } from '../User';\nimport UserSettings from '../UserSettings';\nimport XDLError from '../XDLError';\nimport * as Logger from './ProjectUtils';\nimport { assertValidProjectRoot } from './errors';\nimport { NgrokOptions, resolveNgrokAsync } from './resolveNgrok';\n\nfunction getNgrokConfigPath() {\n  return path.join(UserSettings.dotExpoHomeDirectory(), 'ngrok.yml');\n}\n\nasync function connectToNgrokAsync(\n  projectRoot: string,\n  ngrok: any,\n  args: NgrokOptions,\n  hostnameAsync: () => Promise<string>,\n  ngrokPid: number | null | undefined,\n  attempts: number = 0\n): Promise<string> {\n  const ngrokConnectAsync = promisify(ngrok.connect);\n  const ngrokKillAsync = promisify(ngrok.kill);\n\n  try {\n    const configPath = getNgrokConfigPath();\n    const hostname = await hostnameAsync();\n    const url = await ngrokConnectAsync({\n      hostname,\n      configPath,\n      ...args,\n    });\n    return url;\n  } catch (e) {\n    // Attempt to connect 3 times\n    if (attempts >= 2) {\n      if (e.message) {\n        throw new XDLError('NGROK_ERROR', e.toString());\n      } else {\n        throw new XDLError('NGROK_ERROR', JSON.stringify(e));\n      }\n    }\n    if (!attempts) {\n      attempts = 0;\n    } // Attempt to fix the issue\n    if (e.error_code && e.error_code === 103) {\n      if (attempts === 0) {\n        // Failed to start tunnel. Might be because url already bound to another session.\n        if (ngrokPid) {\n          try {\n            process.kill(ngrokPid, 'SIGKILL');\n          } catch (e) {\n            Logger.logDebug(projectRoot, 'expo', `Couldn't kill ngrok with PID ${ngrokPid}`);\n          }\n        } else {\n          await ngrokKillAsync();\n        }\n      } else {\n        // Change randomness to avoid conflict if killing ngrok didn't help\n        await Exp.resetProjectRandomnessAsync(projectRoot);\n      }\n    } // Wait 100ms and then try again\n    await delayAsync(100);\n    return connectToNgrokAsync(projectRoot, ngrok, args, hostnameAsync, null, attempts + 1);\n  }\n}\n\nconst TUNNEL_TIMEOUT = 10 * 1000;\n\nexport async function startTunnelsAsync(\n  projectRoot: string,\n  options: { autoInstall?: boolean } = {}\n): Promise<void> {\n  const ngrok = await resolveNgrokAsync(projectRoot, options);\n\n  const username = (await UserManager.getCurrentUsernameAsync()) || ANONYMOUS_USERNAME;\n  assertValidProjectRoot(projectRoot);\n  const packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    throw new XDLError('NO_PACKAGER_PORT', `No packager found for project at ${projectRoot}.`);\n  }\n  if (!packagerInfo.expoServerPort) {\n    throw new XDLError(\n      'NO_EXPO_SERVER_PORT',\n      `No Expo server found for project at ${projectRoot}.`\n    );\n  }\n  const expoServerPort = packagerInfo.expoServerPort;\n  await stopTunnelsAsync(projectRoot);\n  if (await Android.startAdbReverseAsync(projectRoot)) {\n    Logger.logInfo(\n      projectRoot,\n      'expo',\n      'Successfully ran `adb reverse`. Localhost URLs should work on the connected Android device.'\n    );\n  }\n  const packageShortName = path.parse(projectRoot).base;\n  const expRc = await readExpRcAsync(projectRoot);\n\n  let startedTunnelsSuccessfully = false;\n\n  // Some issues with ngrok cause it to hang indefinitely. After\n  // TUNNEL_TIMEOUTms we just throw an error.\n  await Promise.race([\n    (async () => {\n      await delayAsync(TUNNEL_TIMEOUT);\n      if (!startedTunnelsSuccessfully) {\n        throw new Error('Starting tunnels timed out');\n      }\n    })(),\n    (async () => {\n      const expoServerNgrokUrl = await connectToNgrokAsync(\n        projectRoot,\n        ngrok,\n        {\n          authtoken: Config.ngrok.authToken,\n          port: expoServerPort,\n          proto: 'http',\n        },\n        async () => {\n          const randomness = expRc.manifestTunnelRandomness\n            ? expRc.manifestTunnelRandomness\n            : await Exp.getProjectRandomnessAsync(projectRoot);\n          return [\n            randomness,\n            UrlUtils.domainify(username),\n            UrlUtils.domainify(packageShortName),\n            Config.ngrok.domain,\n          ].join('.');\n        },\n        packagerInfo.ngrokPid\n      );\n      const packagerNgrokUrl = await connectToNgrokAsync(\n        projectRoot,\n        ngrok,\n        {\n          authtoken: Config.ngrok.authToken,\n          port: packagerInfo.packagerPort,\n          proto: 'http',\n        },\n        async () => {\n          const randomness = expRc.manifestTunnelRandomness\n            ? expRc.manifestTunnelRandomness\n            : await Exp.getProjectRandomnessAsync(projectRoot);\n          return [\n            'packager',\n            randomness,\n            UrlUtils.domainify(username),\n            UrlUtils.domainify(packageShortName),\n            Config.ngrok.domain,\n          ].join('.');\n        },\n        packagerInfo.ngrokPid\n      );\n      await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n        expoServerNgrokUrl,\n        packagerNgrokUrl,\n        ngrokPid: ngrok.process().pid,\n      });\n\n      startedTunnelsSuccessfully = true;\n\n      Logger.logWithLevel(\n        projectRoot,\n        'info',\n        {\n          tag: 'expo',\n          _expoEventType: 'TUNNEL_READY',\n        },\n        'Tunnel ready.'\n      );\n\n      ngrok.addListener('statuschange', (status: string) => {\n        if (status === 'reconnecting') {\n          Logger.logError(\n            projectRoot,\n            'expo',\n            'We noticed your tunnel is having issues. ' +\n              'This may be due to intermittent problems with our tunnel provider. ' +\n              'If you have trouble connecting to your app, try to Restart the project, ' +\n              'or switch Host to LAN.'\n          );\n        } else if (status === 'online') {\n          Logger.logInfo(projectRoot, 'expo', 'Tunnel connected.');\n        }\n      });\n    })(),\n  ]);\n}\n\nexport async function stopTunnelsAsync(projectRoot: string): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  const ngrok = await resolveNgrokAsync(projectRoot, { shouldPrompt: false }).catch(() => null);\n  if (!ngrok) {\n    return;\n  }\n  const ngrokKillAsync = promisify(ngrok.kill);\n\n  // This will kill all ngrok tunnels in the process.\n  // We'll need to change this if we ever support more than one project\n  // open at a time in XDE.\n  const packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  const ngrokProcess = ngrok.process();\n  const ngrokProcessPid = ngrokProcess ? ngrokProcess.pid : null;\n  ngrok.removeAllListeners('statuschange');\n  if (packagerInfo.ngrokPid && packagerInfo.ngrokPid !== ngrokProcessPid) {\n    // Ngrok is running in some other process. Kill at the os level.\n    try {\n      process.kill(packagerInfo.ngrokPid);\n    } catch (e) {\n      Logger.logDebug(projectRoot, 'expo', `Couldn't kill ngrok with PID ${packagerInfo.ngrokPid}`);\n    }\n  } else {\n    // Ngrok is running from the current process. Kill using ngrok api.\n    await ngrokKillAsync();\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerNgrokUrl: null,\n    packagerNgrokUrl: null,\n    ngrokPid: null,\n  });\n  await Android.stopAdbReverseAsync(projectRoot);\n}\n"],"file":"../../project/ngrok.js","sourceRoot":"/@expo/xdl@59.0.19/src"}